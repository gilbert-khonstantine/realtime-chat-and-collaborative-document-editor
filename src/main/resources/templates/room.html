<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Collaborative Document</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
</head>
<body>
<div class="containter">
    <div class="columns is-mobile is-centered">
        <div class="column is-half">
            <h1 class="title is-3" th:text="'Welcome to '+${room.name}"></h1>
            <div class="block">
                <textarea autofocus id="shared-doc" class="textarea is-primary" placeholder="Dicussion Text Here" onfocus="textAreaAdjust(this)" onkeyup="textAreaAdjust(this)" th:text="${room.text}"></textarea>
            </div>
            <a class="button is-primary" href="/index">go back</a>
        </div>
    </div>
</div>

</body>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.0.0/diff.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
var id = [[${room.id}]];
var name = [[${room.name}]];
/*]]>*/
var stompClient = null;
var username = null;
var socket = null;
var lastChange = 0;
function connect(event) {
    username = "random name generator here";

    if(username) {
         socket = new SockJS('/chat');
         socket.onopen = function() {
             console.log('open');
             socket.send('test');
         };
         stompClient = Stomp.over(socket);

        stompClient.connect({}, onConnected, onError);
    }
    // event.preventDefault();
}

function onError(error) {
    console.log(error)
}

function onConnected() {
    // Subscribe to the Public Topic
    stompClient.subscribe('/topic/public/'+id, onMessageReceived);
}
function onMessageReceived(payload) {
    var documentContent = document.getElementById("shared-doc");
    // Do some postprocessing of the content
    var currentPos = documentContent.selectionStart;
    var incomingJson = JSON.parse(payload.body)
    savedText = incomingJson.content
    incomingTime = incomingJson.time
    incomingChange = documentContent.value
    if (Math.abs(incomingTime - lastChange) < 15000){
        // add in both changes
        // currently does not support deletion. So if you want to delete, only 1 person delete at a time
        var unifiedString = ""
        Diff.diffChars(incomingChange, savedText).forEach(part=>{
            unifiedString = unifiedString + part.value
        })
        documentContent.value = unifiedString
    } else if (incomingTime - lastChange > 15000) {
        documentContent.value = savedText
    } else if (incomingTime - lastChange < -15000){
        documentContent.value = incomingChange
    }

    // Fix the cursor position in the text box
    documentContent.setSelectionRange(currentPos, currentPos);

}

function send(event) {
    var documentContent = document.getElementById("shared-doc").value;

    if(stompClient) {
        var chatMessage = {
            sender: username,
            content: documentContent,
            roomId: id,
            roomName: name,
            time: Date.now()
        };
        lastChange = Date.now();

        stompClient.send("/room/document/"+id, {}, JSON.stringify(chatMessage));
    }
    // event.preventDefault();
}
var delay = (function(){
    var timer = 0;
    return function(callback, ms){
        clearTimeout(timer);
        timer = setTimeout(callback,ms);
    };
})();
document.getElementById("shared-doc").addEventListener("keydown",e => {
        delay(function(){
            send(e.target.innerHTML)
        },1000)
});
function textAreaAdjust(element) {
  element.style.height = "1px";
  element.style.height = (25+element.scrollHeight)+"px";
}
window.onload = (e) => connect(e);
</script>
</html>
